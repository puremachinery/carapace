#!/bin/bash
# Pre-commit hook: check formatting, run clippy, and scan for leaked secrets.
# Install via: just setup-hooks

set -euo pipefail

echo "Running cargo fmt --check..."
if ! cargo fmt --all --check; then
    echo "Formatting check failed. Run 'cargo fmt' to fix."
    exit 1
fi

echo "Running cargo clippy --all-features --all-targets -- -D warnings..."
if ! cargo clippy --all-features --all-targets -- -D warnings; then
    echo "Clippy check failed. Fix the warnings above."
    exit 1
fi

# Scan staged changes for leaked secrets (if gitleaks is installed).
if command -v gitleaks >/dev/null 2>&1; then
    echo "Running gitleaks on staged changes..."
    if ! gitleaks git --staged --no-banner; then
        echo "gitleaks detected secrets in staged changes. Review and remove them."
        echo "To see details: gitleaks git --staged --verbose"
        exit 1
    fi
else
    echo "gitleaks not installed, skipping secret scan. See https://github.com/gitleaks/gitleaks#install"
fi

echo "Pre-commit checks passed"
