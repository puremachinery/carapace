#!/bin/bash
# Pre-push hook: run tests unless the push only changes docs/site/meta files.
# Install via: just setup-hooks

set -euo pipefail

remote_name="${1:-origin}"

default_remote_ref="$(git symbolic-ref --quiet --short "refs/remotes/${remote_name}/HEAD" 2>/dev/null || true)"
default_branch="${default_remote_ref#${remote_name}/}"
if [ -z "$default_branch" ]; then
    default_branch="master"
fi

is_zero_sha() {
    [ "$1" = "0000000000000000000000000000000000000000" ]
}

is_docs_or_site_only_path() {
    case "$1" in
        docs/*|website/*|.github/*|.local/*|*.md|*.MD|*.txt|*.rst|*.adoc|*.yml|*.yaml)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

declare -a changed_files=()
saw_ref_updates=0

while read -r local_ref local_sha remote_ref remote_sha; do
    [ -z "${local_ref:-}" ] && continue
    saw_ref_updates=1

    # Deleted refs have an all-zero local SHA; nothing to validate.
    if is_zero_sha "$local_sha"; then
        continue
    fi

    if is_zero_sha "$remote_sha"; then
        base_ref="${remote_name}/${default_branch}"
        base_sha="$(git merge-base "$local_sha" "$base_ref" 2>/dev/null || true)"
        if [ -n "$base_sha" ]; then
            range="${base_sha}..${local_sha}"
        else
            range="${local_sha}^..${local_sha}"
        fi
    else
        range="${remote_sha}..${local_sha}"
    fi

    while IFS= read -r path; do
        [ -n "$path" ] && changed_files+=("$path")
    done < <(git diff --name-only "$range")
done

if [ "$saw_ref_updates" -eq 0 ]; then
    echo "No push ref payload detected (manual run); running tests."
    changed_files=("__manual__")
fi

if [ "${#changed_files[@]}" -eq 0 ]; then
    echo "No changed files detected in ref updates; skipping tests."
    exit 0
fi

needs_tests=0
while IFS= read -r path; do
    if ! is_docs_or_site_only_path "$path"; then
        needs_tests=1
        break
    fi
done < <(printf '%s\n' "${changed_files[@]}" | sort -u)

if [ "$needs_tests" -eq 0 ]; then
    echo "Docs/website/meta-only changes detected; skipping cargo nextest."
    exit 0
fi

echo "Code-impacting changes detected. Running tests before push..."

if ! command -v cargo-nextest >/dev/null 2>&1; then
    echo "cargo-nextest is required. Install with: cargo install cargo-nextest"
    exit 1
fi

if ! cargo nextest run --all-targets; then
    echo "Tests failed. Fix failing tests before pushing."
    exit 1
fi

echo "All tests passed, pushing..."
