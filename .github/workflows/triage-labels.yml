name: Sync Triage Labels

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - ".github/workflows/triage-labels.yml"
      - ".github/ISSUE_TEMPLATE/**"

permissions:
  issues: write

jobs:
  sync-labels:
    name: Sync Labels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          TRIAGE_LABELS_JSON: >-
            [{"name":"triage","color":"fbca04","description":"Needs initial triage and routing"},
            {"name":"feedback","color":"5319e7","description":"User feedback from setup, usage, or outreach"},
            {"name":"smoke","color":"1d76db","description":"Smoke-test evidence and regressions"},
            {"name":"onboarding","color":"0e8a16","description":"Install/setup/getting-started experience"},
            {"name":"channel","color":"0052cc","description":"Messaging channel integrations and behavior"},
            {"name":"security","color":"b60205","description":"Security controls, vulnerabilities, or hardening"},
            {"name":"docs","color":"0366d6","description":"Documentation quality, gaps, and corrections"},
            {"name":"bug","color":"d73a4a","description":"Something is not working"},
            {"name":"enhancement","color":"a2eeef","description":"New feature or request"}]
        with:
          script: |
            const desired = JSON.parse(process.env.TRIAGE_LABELS_JSON);
            const existing = await github.paginate(github.rest.issues.listLabelsForRepo, {
              ...context.repo,
              per_page: 100,
            });
            const existingByName = new Map(
              existing.map((label) => [label.name.toLowerCase(), label])
            );

            for (const label of desired) {
              const current = existingByName.get(label.name.toLowerCase());
              if (!current) {
                await github.rest.issues.createLabel({
                  ...context.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description,
                });
                core.info(`Created label: ${label.name}`);
                continue;
              }

              if (
                current.name !== label.name ||
                current.color.toLowerCase() !== label.color.toLowerCase() ||
                (current.description || "") !== label.description
              ) {
                await github.rest.issues.updateLabel({
                  ...context.repo,
                  name: current.name,
                  new_name: label.name,
                  color: label.color,
                  description: label.description,
                });
                core.info(`Updated label: ${label.name}`);
              } else {
                core.info(`No changes for label: ${label.name}`);
              }
            }
