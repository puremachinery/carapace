name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    outputs:
      workflow_changed: ${{ steps.workflow-change.outputs.changed }}
      cleanup_started_at: ${{ steps.cleanup-window.outputs.started_at }}
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    # Only run on PRs from the same repo (fork PRs don't have access to secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository && github.event.pull_request.draft == false

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 1
          ref: refs/pull/${{ github.event.pull_request.number }}/head

      - name: Detect workflow self-change
        id: workflow-change
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100,
            });
            const blocked = new Set([
              ".github/workflows/claude-code-review.yml",
              ".github/workflows/claude.yml",
            ]);
            const changed = files.some((file) => blocked.has(file.filename));
            core.setOutput("changed", changed ? "true" : "false");

      - name: Skip Claude review when workflow changed in PR
        if: steps.workflow-change.outputs.changed == 'true'
        run: |
          echo "Skipping Claude code review because this PR modifies Claude workflow files."

      - name: Record cleanup window start time
        id: cleanup-window
        run: |
          # Safety buffer handles small clock skew between runner and GitHub comment timestamps.
          echo "started_at=$(date -u -d '2 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Run Claude Code Review
        id: claude-review
        if: steps.workflow-change.outputs.changed != 'true'
        uses: anthropics/claude-code-action@2f8ba26a219c06cfb0f468eef8d97055fa814f97 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request for:
            - correctness/regressions
            - security risks
            - test coverage gaps
            - maintainability concerns

            STRICT REVIEW POLICY
            1) Use severities: critical, high, medium, low, info.
            2) Inline review comments are allowed ONLY for in-scope critical/high/medium findings with concrete impact.
               - Put each in-scope critical/high/medium finding on its relevant line as one inline comment.
               - Never inline-comment low/info findings.
            3) Every finding must include:
               - severity
               - scope tag: in-scope or out-of-scope for this PR
               - concrete impact and concise fix
            4) Dedupe aggressively across pushes:
               - Before posting, inspect existing review threads with gh pr view.
               - Do NOT post a new comment for the same root cause if one already exists unresolved.
            5) low findings:
               - Do NOT post inline.
               - Include low findings only as one aggregate section in the single review body:
                 "Optional follow-ups (non-blocking)".
            6) info findings:
               - Suppress entirely (do not post inline or in review body).
            7) Blocking policy:
               - Only in-scope critical/high/medium findings are blocking for this PR.
               - Out-of-scope findings are advisory only.
            8) Review format:
               - Submit exactly ONE GitHub pull-request review on every run.
               - If there are one or more in-scope critical/high/medium findings, review body must start with:
                 "Blocking findings present."
               - If there are zero in-scope critical/high/medium findings, review body must start with:
                 "LGTM for blocking issues."
               - Never create standalone PR conversation comments.
               - Never create issue comments.
               - Never create additional reviews, retries, test, or placeholder comments.

            Required review body structure:
            - Header line: one of the two exact lines above.
            - One short summary paragraph.
            - If blocking findings exist: "### Blocking findings (required before merge)" section.
            - If advisory out-of-scope critical/high/medium findings exist:
              "### Advisory findings (out-of-scope)" section.
            - If low findings exist:
              exactly one "### Optional follow-ups (non-blocking)" section with compact bullets.

            Output requirements:
            - Use GitHub Review API flow (pending review -> inline review comments -> submit review).
            - Do not use gh pr comment.
            - Do not use issue comment endpoints.
            - Do not post duplicate content across pushes.
            - Keep inline comments concise and non-repetitive.
          claude_args: |
            --allowedTools "Bash(gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(git:*),WebSearch"

  cleanup-claude-stray-comments:
    name: Delete stray Claude issue comments from this run
    needs: [claude-review]
    if: always() && needs.claude-review.outputs.workflow_changed != 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Delete comments
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        env:
          RUN_STARTED_AT: ${{ needs.claude-review.outputs.cleanup_started_at }}
        with:
          script: |
            const startedAt = Date.parse(process.env.RUN_STARTED_AT || "");
            if (Number.isNaN(startedAt)) {
              core.warning(`Invalid RUN_STARTED_AT: ${process.env.RUN_STARTED_AT}`);
              return;
            }
            const issueNumber = context.payload.pull_request.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100,
            });
            const stray = comments.filter((comment) => {
              const login = comment.user?.login || "";
              const createdAt = Date.parse(comment.created_at || "");
              return login === "claude[bot]" && !Number.isNaN(createdAt) && createdAt >= startedAt;
            });
            for (const comment of stray) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }
            core.info(`Deleted ${stray.length} stray issue comment(s) from claude[bot].`);
