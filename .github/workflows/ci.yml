name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  changes:
    name: Detect Changed Categories
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.filter.outputs.docs }}
      workflow: ${{ steps.filter.outputs.workflow }}
      rust_runtime: ${{ steps.filter.outputs.rust_runtime }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docs:
              - "docs/**"
              - "**/*.md"
              - "LICENSE"
              - "CHANGELOG.md"
            workflow:
              - ".github/workflows/**"
            rust_runtime:
              - "src/**"
              - "tests/**"
              - "fuzz/**"
              - "wit/**"
              - "Cargo.toml"
              - "Cargo.lock"
              - "build.rs"
              - "Justfile"
              - "deny.toml"
              - "config.example.json5"
              - ".cargo/**"
            docker:
              - "Dockerfile"
              - ".dockerignore"
              - ".hadolint.yaml"

  fmt:
    name: Format
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets --all-features -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --all-targets

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@nextest
      - run: cargo nextest run --all-targets

  msrv:
    name: MSRV
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.93.0
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --all-targets

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/install-action@cargo-audit
      - run: cargo audit

  deny:
    name: Dependency Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/install-action@cargo-deny
      - run: cargo deny check

  gitleaks:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  hadolint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true' || needs.changes.outputs.docker == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: fs
          scan-ref: .
          severity: CRITICAL,HIGH
          exit-code: 1
      - name: Run Trivy config scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: config
          scan-ref: .
          severity: CRITICAL,HIGH
          exit-code: 1

  geiger:
    name: Unsafe Code Audit
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.rust_runtime == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-geiger
        run: cargo install cargo-geiger
      - name: Report unsafe usage
        run: cargo geiger --all-targets --output-format ascii 2>&1 | tee geiger-report.txt
      - name: Upload geiger report
        uses: actions/upload-artifact@v4
        with:
          name: geiger-report
          path: geiger-report.txt

  workflow-lint:
    name: Workflow Lint
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.workflow == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Run actionlint
        uses: rhysd/actionlint@393031adb9afb225ee52ae2ccd7a5af5525e03e8 # v1.7.11
        with:
          args: -color -shellcheck=

  docs-check:
    name: Docs Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Basic markdown sanity check
        run: |
          echo "Checking Markdown files for hard tabs"
          if grep -RIn $'\t' --include='*.md' --exclude-dir=.git --exclude-dir=target .; then
            echo "Found tab characters in Markdown files; please use spaces."
            exit 1
          fi

  ci-required:
    name: CI Required
    runs-on: ubuntu-latest
    if: always()
    needs:
      - changes
      - fmt
      - clippy
      - build
      - test
      - msrv
      - audit
      - deny
      - gitleaks
      - hadolint
      - trivy
      - geiger
      - workflow-lint
      - docs-check
    steps:
      - name: Ensure dependent jobs are success or skipped
        env:
          CHANGES_RESULT: ${{ needs.changes.result }}
          FMT_RESULT: ${{ needs.fmt.result }}
          CLIPPY_RESULT: ${{ needs.clippy.result }}
          BUILD_RESULT: ${{ needs.build.result }}
          TEST_RESULT: ${{ needs.test.result }}
          MSRV_RESULT: ${{ needs.msrv.result }}
          AUDIT_RESULT: ${{ needs.audit.result }}
          DENY_RESULT: ${{ needs.deny.result }}
          GITLEAKS_RESULT: ${{ needs.gitleaks.result }}
          HADOLINT_RESULT: ${{ needs.hadolint.result }}
          TRIVY_RESULT: ${{ needs.trivy.result }}
          GEIGER_RESULT: ${{ needs.geiger.result }}
          WORKFLOW_LINT_RESULT: ${{ needs['workflow-lint'].result }}
          DOCS_CHECK_RESULT: ${{ needs['docs-check'].result }}
        run: |
          set -euo pipefail

          names=(
            "changes"
            "fmt"
            "clippy"
            "build"
            "test"
            "msrv"
            "audit"
            "deny"
            "gitleaks"
            "hadolint"
            "trivy"
            "geiger"
            "workflow-lint"
            "docs-check"
          )

          results=(
            "$CHANGES_RESULT"
            "$FMT_RESULT"
            "$CLIPPY_RESULT"
            "$BUILD_RESULT"
            "$TEST_RESULT"
            "$MSRV_RESULT"
            "$AUDIT_RESULT"
            "$DENY_RESULT"
            "$GITLEAKS_RESULT"
            "$HADOLINT_RESULT"
            "$TRIVY_RESULT"
            "$GEIGER_RESULT"
            "$WORKFLOW_LINT_RESULT"
            "$DOCS_CHECK_RESULT"
          )

          for i in "${!names[@]}"; do
            name="${names[$i]}"
            result="${results[$i]}"
            echo "${name}: ${result}"
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              echo "Job ${name} did not succeed"
              exit 1
            fi
          done
